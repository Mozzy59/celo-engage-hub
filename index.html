<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Celo Engage Hub</title>
    <style>
        * { box-sizing: border-box; }
        body { background-color: #ffffff; font-family: Arial, sans-serif; color: #000000; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { display: flex; max-width: 1400px; width: 100%; gap: 30px; align-items: flex-start; }
        .sidebar { width: 300px; flex-shrink: 0; }
        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; }
        header { background: linear-gradient(135deg, #FBCC5C 0%, #000000 100%); color: white; padding: 25px; font-size: 28px; font-weight: bold; border-radius: 10px; margin-bottom: 10px; text-align: center; width: 100%; max-width: 1400px; }
        .slogan { margin: 5px 0 15px 0; font-size: 22px; color: #000000; font-weight: bold; text-align: center; width: 100%; font-style: italic; }
        .subheader { margin: 0 0 30px 0; font-size: 18px; color: #000000; font-weight: bold; text-align: center; width: 100%; }
        .link-card { border: 2px solid #FBCC5C; padding: 20px; border-radius: 12px; background-color: #FFFDF6; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; height: 100%; display: flex; flex-direction: column; justify-content: space-between; }
        .link-card.completed { border-color: #35D07F; background-color: #F0FFF7; }
        .links-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px auto; width: 100%; }
        button { background: #FBCC5C; color: black; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin: 8px; font-size: 16px; font-weight: bold; transition: all 0.3s ease; }
        button:hover { background: #000000; color: #FBCC5C; transform: translateY(-2px); }
        button:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }
        input, textarea { padding: 12px; border-radius: 8px; border: 2px solid #FBCC5C; width: 90%; max-width: 500px; margin: 15px 0; font-size: 16px; }
        .wallet-info { margin: 0 0 20px 0; padding: 15px; background-color: #FFF9E6; border-radius: 10px; font-weight: bold; border: 2px solid #FBCC5C; text-align: center; width: 100%; }
        .connect-btn { background: #35D07F; color: black; margin: 15px 0; padding: 15px 25px; font-size: 18px; }
        .support-link { color: #000000; text-decoration: none; word-break: break-all; display: block; margin-bottom: 15px; font-weight: bold; font-size: 16px; line-height: 1.4; }
        .link-platform { font-size: 14px; color: #666; margin-bottom: 10px; font-weight: bold; background: #FFF0C2; padding: 5px 10px; border-radius: 20px; display: inline-block; }
        .step-indicator { margin: 0 0 20px 0; font-weight: bold; color: #000000; font-size: 20px; text-align: center; width: 100%; }
        .step-container { background: #FFFDF6; border: 2px solid #FBCC5C; padding: 25px; border-radius: 12px; text-align: center; height: fit-content; width: 100%; }
        .hidden { display: none !important; }
        .step-number { background: #FBCC5C; color: black; border-radius: 50%; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; margin-right: 10px; }
        .success-message { background: #E8FBF1; border: 2px solid #35D07F; padding: 15px; margin: 15px auto; border-radius: 8px; color: #065f46; font-weight: bold; max-width: 600px; text-align: center; width: 100%; }
        .link-stats { display: flex; justify-content: space-around; margin-top: 15px; font-size: 14px; color: #666; }
        .stat-item { display: flex; flex-direction: column; align-items: center; }
        .stat-value { font-weight: bold; font-size: 18px; color: #000000; }
        .submit-form { background: #FFFDF6; border: 2px solid #FBCC5C; padding: 30px; margin: 20px auto; border-radius: 12px; max-width: 600px; text-align: center; width: 100%; }
        .gas-info { background: #FFF0C2; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 14px; color: #000000; text-align: center; }
        .celo-ecosystem { background: linear-gradient(135deg, #FBCC5C 0%, #000000 100%); color: white; padding: 20px; border-radius: 12px; height: fit-content; }
        .celo-ecosystem h3 { margin: 0 0 15px 0; font-size: 20px; text-align: center; }
        .celo-link { display: flex; align-items: center; padding: 10px; margin: 8px 0; background: rgba(255,255,255,0.1); border-radius: 8px; text-decoration: none; color: white; transition: all 0.3s ease; }
        .celo-link:hover { background: rgba(255,255,255,0.2); transform: translateX(5px); }
        .celo-link-icon { margin-right: 10px; font-size: 18px; }
        .wallet-address { background: #FFF9E6; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; border: 2px solid #FBCC5C; text-align: center; width: 100%; }
        .main-sections { display: flex; flex-direction: column; gap: 30px; width: 100%; align-items: center; }
        .centered-content { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .section-title { font-size: 24px; font-weight: bold; color: #000000; margin: 30px 0 20px 0; text-align: center; width: 100%; }
        .network-warning { background: #FEF3CD; border: 2px solid #F59E0B; padding: 15px; margin: 15px auto; border-radius: 8px; color: #92400E; font-weight: bold; max-width: 600px; text-align: center; width: 100%; }
        .content-layout { display: flex; flex-direction: column; gap: 30px; width: 100%; }
        .submit-section { order: 1; }
        .support-section { order: 2; }
        .governance-section { order: 3; }
        .badge-section { order: 4; }
        .proposal-card { border: 2px solid #35D07F; padding: 20px; border-radius: 12px; background-color: #F0FFF7; margin: 15px 0; }
        .badge-card { border: 2px solid #FBCC5C; padding: 15px; border-radius: 12px; background-color: #FFF9E6; margin: 10px 0; }
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #FFFDF6; border: 2px solid #FBCC5C; padding: 15px; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>
    <div class="centered-content">
        <header>
            <div>üåê Celo Engage Hub</div>
        </header>
        <div class="slogan"> Social TX - Where Every Interaction Builds Real Value </div>
        <div class="subheader">If you want support, support first</div>
        <button id="connectWalletBtn" class="connect-btn">üîó Connect MetaMask</button>
    </div>

    <div class="container">
        <div class="sidebar">
            <div id="walletInfo" class="wallet-address hidden">
                ‚úÖ Connected: <span id="walletAddress"></span>
                <div id="networkInfo" style="font-size: 12px; margin-top: 5px;"></div>
            </div>
            <div class="celo-ecosystem">
                <h3>üü° Celo Ecosystem</h3>
                <a href="https://celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üåê</span>Celo Official </a>
                <a href="https://docs.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üìö</span>Celo Documentation </a>
                <a href="https://developers.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üíº</span>Developer Portal </a>
                <a href="https://celoscan.io" target="_blank" class="celo-link"> <span class="celo-link-icon">üîç</span>Celo Explorer </a>
                <a href="https://forum.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üí¨</span>Celo Forum </a>
                <a href="https://x.com/Celo" target="_blank" class="celo-link"> <span class="celo-link-icon">üê¶</span>Celo Twitter </a>
                <a href="https://chat.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üí¨</span>Celo Discord </a>
                <a href="https://blog.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üì∞</span>Celo Blog </a>
                <a href="https://github.com/celo-org" target="_blank" class="celo-link"> <span class="celo-link-icon">üíª</span>Celo GitHub </a>
            </div>

            <!-- Platform Stats -->
            <div id="platformStats" class="stats-container hidden">
                <div class="stat-card">
                    <div>üë• Total Users</div>
                    <div class="stat-value" id="totalUsers">0</div>
                </div>
                <div class="stat-card">
                    <div>üìã Proposals</div>
                    <div class="stat-value" id="totalProposals">0</div>
                </div>
                <div class="stat-card">
                    <div>üéñÔ∏è Badges</div>
                    <div class="stat-value" id="totalBadges">0</div>
                </div>
                <div class="stat-card">
                    <div>üëç Supports</div>
                    <div class="stat-value" id="totalSupports">0</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="content-layout">
                <!-- USER PROFILE SECTION -->
                <div id="userProfileSection" class="hidden">
                    <div class="step-indicator">
                        <span class="step-number">üë§</span> Your Profile
                    </div>
                    <div class="submit-form">
                        <h3>üÜî Setup Your Profile</h3>
                        <input type="text" placeholder="Enter your username..." id="userUsername" />
                        <input type="text" placeholder="Paste your X, Farcaster, GitHub link..." id="userLink" />
                        <div class="gas-info"> ‚õΩ Setup your profile to unlock all features </div>
                        <button id="setupProfileBtn">üöÄ Setup Profile</button>
                    </div>
                </div>

                <!-- SUBMIT YOUR LINK SECTION -->
                <div id="step2" class="submit-section hidden">
                    <div class="step-indicator">
                        <span class="step-number">2</span> Submit Your Link
                    </div>
                    <div class="success-message"> ‚úÖ Thank you for supporting! Now you can submit your own link </div>
                    <div id="networkWarning" class="network-warning hidden"> ‚ö†Ô∏è Please switch to Celo Mainnet to submit your link </div>
                    <div class="submit-form">
                        <h3>üéâ Add Your Content</h3>
                        <input type="text" placeholder="Paste your X, Farcaster, GitHub, or any other link here..." id="userLinkInput" />
                        <br>
                        <div class="gas-info"> ‚õΩ You'll only pay the normal network gas fee (no extra cost) </div>
                        <button id="submitLinkBtn">‚úçÔ∏è Submit Link</button>
                        <p><small>üîí Secure transaction on Celo network</small></p>
                    </div>
                </div>

                <!-- SUPPORT COMMUNITY SECTION -->
                <div id="step1" class="support-section">
                    <div class="step-indicator">
                        <span class="step-number">1</span> Support Community Members
                    </div>
                    <div class="step-container">
                        <h3>üìã Support Others First</h3>
                        <p>To submit your link, you must first support at least one community member</p>
                        <div class="links-grid" id="linksContainer"> </div>
                    </div>
                </div>

                <!-- GOVERNANCE SECTION -->
                <div id="governanceSection" class="governance-section hidden">
                    <div class="step-indicator">
                        <span class="step-number">üèõÔ∏è</span> Community Governance
                    </div>
                    <div class="step-container">
                        <h3>üó≥Ô∏è Create Proposal</h3>
                        <input type="text" placeholder="Proposal title..." id="proposalTitle" />
                        <textarea placeholder="Proposal description..." id="proposalDescription" rows="3"></textarea>
                        <button id="createProposalBtn">üìù Create Proposal</button>

                        <h3 style="margin-top: 30px;">üìã Active Proposals</h3>
                        <div id="proposalsContainer"></div>
                    </div>
                </div>

                <!-- BADGES SECTION -->
                <div id="badgesSection" class="badge-section hidden">
                    <div class="step-indicator">
                        <span class="step-number">üéñÔ∏è</span> Your Badges
                    </div>
                    <div class="step-container">
                        <h3>üèÜ Your Achievements</h3>
                        <div id="userBadgesContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // State management - SADELE≈ûTƒ∞Rƒ∞LMƒ∞≈û
        let provider = null;
        let signer = null;
        let isConnected = false;
        let userAddress = '';
        let hasSupported = false;
        let currentChainId = null;

        // ‚úÖ ORƒ∞Jƒ∞NAL √áALI≈ûAN CONTRACT ADRESƒ∞
        const CONTRACT_ADDRESS = "0x22eA49c074098931a478F381f971C77486d185b2";

        // ‚úÖ BASƒ∞T VE √áALI≈ûAN ABI
        const CONTRACT_ABI = [
            "function registerUser(string memory _username, string memory _link) public",
            "function getUserProfile(address _user) public view returns (string memory, string memory, uint256, uint256, uint256, bool, uint256)",
            "function totalUsers() public view returns (uint256)",
            "function proposalCount() public view returns (uint256)"
        ];

        // Celo Network Configuration
        const CELO_MAINNET_PARAMS = {
            chainId: "0xA4EC",
            chainName: "Celo Mainnet",
            nativeCurrency: { name: "CELO", symbol: "CELO", decimals: 18 },
            rpcUrls: ["https://forno.celo.org"],
            blockExplorerUrls: ["https://celoscan.io/"]
        };

        // Initial support links
        const initialSupportLinks = [
            "https://farcaster.xyz/teberen/0x391c5713",
            "https://farcaster.xyz/ertu", 
            "https://farcaster.xyz/ratmubaba",
            "https://x.com/erturulsezar13?s=21&t=l2lmnRZcmeoUCu9IdzeRpA",
            "https://x.com/egldmvx?s=21&t=l2lmnRZcmeoUCu9IdzeRpA",
            "https://tebberen.github.io/celo-engage-hub/",
            "https://x.com/meelioodas?s=21&t=l2lmnRZcmeoUCu9IdzeRpA",
            "https://x.com/luckyfromnecef/status/1972371920290259437?s=46&t=l2lmnRZcmeoUCu9IdzeRpA",
            "https://github.com/tebberen"
        ];

        // Utility functions
        function getPlatformName(url) {
            if (url.includes('x.com') || url.includes('twitter.com')) return 'üê¶ X';
            if (url.includes('farcaster.xyz') || url.includes('warpcast.com')) return 'üîÆ Farcaster';
            if (url.includes('github.com')) return 'üíª GitHub';
            return 'üåê Website';
        }

        function displaySupportLinks() {
            const container = document.getElementById('linksContainer');
            container.innerHTML = '';
            const storedLinks = localStorage.getItem('celoEngageHubLinks');
            const allCommunityLinks = storedLinks ? JSON.parse(storedLinks) : initialSupportLinks.map(link => ({ 
                link: link, 
                clickCount: 0, 
                timestamp: Date.now(), 
                submitter: "community" 
            }));
            
            const activeLinks = allCommunityLinks.filter(linkData => linkData.clickCount < 5);
            
            if (activeLinks.length === 0) {
                container.innerHTML = `
                <div style="grid-column: 1 / -1;">
                    <div class="link-card">
                        <p>üåü All links have reached maximum support! Submit new links to continue.</p>
                    </div>
                </div>
                `;
                return;
            }
            
            activeLinks.sort((a, b) => a.clickCount - b.clickCount);
            activeLinks.forEach((linkData) => {
                const platform = getPlatformName(linkData.link);
                const linkCard = document.createElement('div');
                linkCard.innerHTML = `
                <div class="link-card">
                    <div>
                        <div class="link-platform">${platform}</div>
                        <a href="${linkData.link}" target="_blank" class="support-link" onclick="handleLinkClick('${linkData.link}')">
                        ${linkData.link}
                        </a>
                    </div>
                    <div class="link-stats">
                        <div class="stat-item">
                            <div>Supports</div>
                            <div class="stat-value">${linkData.clickCount}/5</div>
                        </div>
                    </div>
                    <button class="supportBtn" onclick="markAsSupported('${linkData.link}')">üëç Support This Content</button>
                </div>
                `;
                container.appendChild(linkCard);
            });
        }

        // ‚úÖ BASƒ∞T VE G√úVENLƒ∞ PROFILE SETUP
        async function setupUserProfile() {
            if (!isConnected) {
                await connectWallet();
                return;
            }

            const username = document.getElementById("userUsername").value.trim();
            const link = document.getElementById("userLink").value.trim();

            if (!username || !link) {
                alert("‚ùå Please enter both username and link");
                return;
            }

            try {
                document.getElementById("setupProfileBtn").disabled = true;
                document.getElementById("setupProfileBtn").textContent = "‚è≥ Setting up...";

                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                // ‚úÖ SADECE TEMEL ƒ∞≈ûLEM - GAS LIMIT OPTƒ∞Mƒ∞ZE
                const tx = await contract.registerUser(username, link, {
                    gasLimit: 500000
                });

                console.log("üîÑ Profile setup TX:", tx.hash);
                alert(`‚è≥ Profile setup submitted!\nTX Hash: ${tx.hash}`);

                await tx.wait();
                alert("‚úÖ Profile setup successfully!");
                
                // Profili yeniden y√ºkle
                loadUserProfile();

            } catch (error) {
                console.error("‚ùå Profile setup error:", error);
                
                if (error.code === 4001) {
                    alert("‚ùå Transaction rejected by user");
                } else {
                    alert("‚ùå Setup failed: " + error.message);
                }
            } finally {
                document.getElementById("setupProfileBtn").disabled = false;
                document.getElementById("setupProfileBtn").textContent = "üöÄ Setup Profile";
            }
        }

        // ‚úÖ BASƒ∞T SUBMIT LINK
        async function submitLink() {
            if (!isConnected) {
                await connectWallet();
                return;
            }
            
            if (!hasSupported) {
                alert("‚ùå Please support at least one community member first!");
                return;
            }

            const userLink = document.getElementById("userLinkInput").value.trim();
            if (!userLink) {
                alert("‚ùå Please enter your link first.");
                return;
            }

            try {
                document.getElementById("submitLinkBtn").disabled = true;
                document.getElementById("submitLinkBtn").textContent = "‚è≥ Submitting...";

                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                // ‚úÖ SADECE TEMEL KAYIT ƒ∞≈ûLEMƒ∞
                const tx = await contract.registerUser("CommunityUser", userLink, {
                    gasLimit: 500000
                });

                console.log("üîÑ Submit link TX:", tx.hash);
                alert(`‚è≥ Link submission submitted!\nTX Hash: ${tx.hash}`);

                await tx.wait();
                alert("‚úÖ Link submitted successfully!");

                // Local storage'a ekle
                const storedLinks = localStorage.getItem('celoEngageHubLinks');
                const allCommunityLinks = storedLinks ? JSON.parse(storedLinks) : initialSupportLinks.map(link => ({ 
                    link: link, 
                    clickCount: 0, 
                    timestamp: Date.now(), 
                    submitter: "community" 
                }));
                
                allCommunityLinks.unshift({
                    link: userLink,
                    clickCount: 0,
                    timestamp: Date.now(),
                    submitter: userAddress
                });
                
                localStorage.setItem('celoEngageHubLinks', JSON.stringify(allCommunityLinks));
                displaySupportLinks();
                
                document.getElementById("userLinkInput").value = "";
                hasSupported = false;
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step1').classList.remove('hidden');

            } catch (error) {
                console.error("‚ùå Submit error:", error);
                
                if (error.code === 4001) {
                    alert("‚ùå Transaction rejected by user");
                } else {
                    alert("‚ùå Submission failed: " + error.message);
                }
            } finally {
                document.getElementById("submitLinkBtn").disabled = false;
                document.getElementById("submitLinkBtn").textContent = "‚úçÔ∏è Submit Link";
            }
        }

        // Platform Stats - BASƒ∞T
        async function loadPlatformStats() {
            if (!provider || !isConnected) return;

            try {
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const totalUsers = await contract.totalUsers();
                document.getElementById('totalUsers').textContent = totalUsers.toString();
                document.getElementById('platformStats').classList.remove('hidden');
            } catch (error) {
                console.log("Stats loading skipped - not critical");
            }
        }

        // User Profile - BASƒ∞T
        async function loadUserProfile() {
            if (!provider || !isConnected) return;

            try {
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const profile = await contract.getUserProfile(userAddress);

                if (profile[5]) { // isActive
                    document.getElementById('userProfileSection').classList.add('hidden');
                    document.getElementById('governanceSection').classList.remove('hidden');
                    document.getElementById('badgesSection').classList.remove('hidden');
                }
            } catch (error) {
                console.log("User profile check - showing setup form");
                document.getElementById('userProfileSection').classList.remove('hidden');
            }
        }

        // Network functions - BASƒ∞T
        async function switchToCeloNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: CELO_MAINNET_PARAMS.chainId }],
                });
                return true;
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [CELO_MAINNET_PARAMS],
                    });
                    return true;
                }
                return false;
            }
        }

        function handleLinkClick(linkUrl) {
            const storedLinks = localStorage.getItem('celoEngageHubLinks');
            const allCommunityLinks = storedLinks ? JSON.parse(storedLinks) : initialSupportLinks.map(link => ({ 
                link: link, 
                clickCount: 0, 
                timestamp: Date.now(), 
                submitter: "community" 
            }));
            
            const linkData = allCommunityLinks.find(item => item.link === linkUrl);
            if (linkData && linkData.clickCount < 5) {
                linkData.clickCount++;
                localStorage.setItem('celoEngageHubLinks', JSON.stringify(allCommunityLinks));
                displaySupportLinks();
            }
        }

        function markAsSupported(linkUrl) {
            handleLinkClick(linkUrl);
            hasSupported = true;
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        }

        function checkMetaMask() {
            return typeof window.ethereum !== 'undefined';
        }

        // ‚úÖ BASƒ∞T VE G√úVENLƒ∞ WALLET CONNECTION
        async function connectWallet() {
            if (!checkMetaMask()) {
                alert("‚ùå MetaMask not detected. Please install MetaMask first.");
                return false;
            }

            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await switchToCeloNetwork();
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                document.getElementById('walletAddress').textContent = 
                    `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
                document.getElementById('walletInfo').classList.remove('hidden');
                document.getElementById('connectWalletBtn').style.display = 'none';
                
                isConnected = true;
                loadPlatformStats();
                loadUserProfile();

                return true;
            } catch (error) {
                console.error("Connection error:", error);
                alert("‚ùå Connection failed: " + (error.message || "Unknown error"));
                return false;
            }
        }

        // Event listeners
        document.getElementById("connectWalletBtn").addEventListener("click", connectWallet);
        document.getElementById("submitLinkBtn").addEventListener("click", submitLink);
        document.getElementById("setupProfileBtn").addEventListener("click", setupUserProfile);

        // Initialize
        window.addEventListener('load', function() {
            displaySupportLinks();
            if (checkMetaMask()) {
                // Otomatik baƒülanmayƒ± deneyebiliriz
                setTimeout(async () => {
                    try {
                        provider = new ethers.providers.Web3Provider(window.ethereum);
                        const accounts = await provider.listAccounts();
                        if (accounts.length > 0) {
                            await connectWallet();
                        }
                    } catch (error) {
                        console.log("No auto-connection");
                    }
                }, 1000);
            }
        });

        // Global functions
        window.markAsSupported = markAsSupported;
        window.handleLinkClick = handleLinkClick;
    </script>
</body>
</html>
