<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Celo Engage Hub</title>
    <style>
        * { box-sizing: border-box; }
        body { background-color: #ffffff; font-family: Arial, sans-serif; color: #000000; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { display: flex; max-width: 1400px; width: 100%; gap: 30px; align-items: flex-start; }
        .sidebar { width: 300px; flex-shrink: 0; }
        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; }
        header { background: linear-gradient(135deg, #FBCC5C 0%, #000000 100%); color: white; padding: 25px; font-size: 28px; font-weight: bold; border-radius: 10px; margin-bottom: 10px; text-align: center; width: 100%; max-width: 1400px; }
        .slogan { margin: 5px 0 15px 0; font-size: 22px; color: #000000; font-weight: bold; text-align: center; width: 100%; font-style: italic; }
        .subheader { margin: 0 0 30px 0; font-size: 18px; color: #000000; font-weight: bold; text-align: center; width: 100%; }
        .link-card { border: 2px solid #FBCC5C; padding: 20px; border-radius: 12px; background-color: #FFFDF6; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; height: 100%; display: flex; flex-direction: column; justify-content: space-between; }
        .link-card.completed { border-color: #35D07F; background-color: #F0FFF7; }
        .links-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px auto; width: 100%; }
        button { background: #FBCC5C; color: black; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin: 8px; font-size: 16px; font-weight: bold; transition: all 0.3s ease; }
        button:hover { background: #000000; color: #FBCC5C; transform: translateY(-2px); }
        button:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }
        input, textarea { padding: 12px; border-radius: 8px; border: 2px solid #FBCC5C; width: 90%; max-width: 500px; margin: 15px 0; font-size: 16px; }
        .wallet-info { margin: 0 0 20px 0; padding: 15px; background-color: #FFF9E6; border-radius: 10px; font-weight: bold; border: 2px solid #FBCC5C; text-align: center; width: 100%; }
        .connect-btn { background: #35D07F; color: black; margin: 15px 0; padding: 15px 25px; font-size: 18px; }
        .support-link { color: #000000; text-decoration: none; word-break: break-all; display: block; margin-bottom: 15px; font-weight: bold; font-size: 16px; line-height: 1.4; }
        .link-platform { font-size: 14px; color: #666; margin-bottom: 10px; font-weight: bold; background: #FFF0C2; padding: 5px 10px; border-radius: 20px; display: inline-block; }
        .step-indicator { margin: 0 0 20px 0; font-weight: bold; color: #000000; font-size: 20px; text-align: center; width: 100%; }
        .step-container { background: #FFFDF6; border: 2px solid #FBCC5C; padding: 25px; border-radius: 12px; text-align: center; height: fit-content; width: 100%; }
        .hidden { display: none !important; }
        .step-number { background: #FBCC5C; color: black; border-radius: 50%; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; margin-right: 10px; }
        .success-message { background: #E8FBF1; border: 2px solid #35D07F; padding: 15px; margin: 15px auto; border-radius: 8px; color: #065f46; font-weight: bold; max-width: 600px; text-align: center; width: 100%; }
        .link-stats { display: flex; justify-content: space-around; margin-top: 15px; font-size: 14px; color: #666; }
        .stat-item { display: flex; flex-direction: column; align-items: center; }
        .stat-value { font-weight: bold; font-size: 18px; color: #000000; }
        .submit-form { background: #FFFDF6; border: 2px solid #FBCC5C; padding: 30px; margin: 20px auto; border-radius: 12px; max-width: 600px; text-align: center; width: 100%; }
        .gas-info { background: #FFF0C2; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 14px; color: #000000; text-align: center; }
        .celo-ecosystem { background: linear-gradient(135deg, #FBCC5C 0%, #000000 100%); color: white; padding: 20px; border-radius: 12px; height: fit-content; }
        .celo-ecosystem h3 { margin: 0 0 15px 0; font-size: 20px; text-align: center; }
        .celo-link { display: flex; align-items: center; padding: 10px; margin: 8px 0; background: rgba(255,255,255,0.1); border-radius: 8px; text-decoration: none; color: white; transition: all 0.3s ease; }
        .celo-link:hover { background: rgba(255,255,255,0.2); transform: translateX(5px); }
        .celo-link-icon { margin-right: 10px; font-size: 18px; }
        .wallet-address { background: #FFF9E6; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; border: 2px solid #FBCC5C; text-align: center; width: 100%; }
        .main-sections { display: flex; flex-direction: column; gap: 30px; width: 100%; align-items: center; }
        .centered-content { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .section-title { font-size: 24px; font-weight: bold; color: #000000; margin: 30px 0 20px 0; text-align: center; width: 100%; }
        .network-warning { background: #FEF3CD; border: 2px solid #F59E0B; padding: 15px; margin: 15px auto; border-radius: 8px; color: #92400E; font-weight: bold; max-width: 600px; text-align: center; width: 100%; }
        .content-layout { display: flex; flex-direction: column; gap: 30px; width: 100%; }
        .submit-section { order: 1; }
        .support-section { order: 2; }
        .governance-section { order: 3; }
        .badge-section { order: 4; }
        .factory-section { order: 5; }
        .proposal-card { border: 2px solid #35D07F; padding: 20px; border-radius: 12px; background-color: #F0FFF7; margin: 15px 0; }
        .badge-card { border: 2px solid #FBCC5C; padding: 15px; border-radius: 12px; background-color: #FFF9E6; margin: 10px 0; }
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #FFFDF6; border: 2px solid #FBCC5C; padding: 15px; border-radius: 8px; text-align: center; }
        .factory-card { border: 2px solid #9B87F5; padding: 20px; border-radius: 12px; background-color: #F8F5FF; margin: 15px 0; }
        .factory-result { background: #F0F4FF; padding: 15px; border-radius: 8px; margin: 15px 0; word-break: break-all; }
        .error-message { background: #FEF2F2; border: 2px solid #EF4444; padding: 15px; margin: 15px auto; border-radius: 8px; color: #DC2626; font-weight: bold; max-width: 600px; text-align: center; width: 100%; }
    </style>
</head>
<body>
    <div class="centered-content">
        <header>
            <div>üåê Celo Engage Hub</div>
        </header>
        <div class="slogan"> Social TX - Where Every Interaction Builds Real Value </div>
        <div class="subheader">If you want support, support first</div>
        <button id="connectWalletBtn" class="connect-btn">üîó Connect MetaMask</button>
    </div>

    <div class="container">
        <div class="sidebar">
            <div id="walletInfo" class="wallet-address hidden">
                ‚úÖ Connected: <span id="walletAddress"></span>
                <div id="networkInfo" style="font-size: 12px; margin-top: 5px;"></div>
            </div>
            <div class="celo-ecosystem">
                <h3>üü° Celo Ecosystem</h3>
                <a href="https://celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üåê</span>Celo Official </a>
                <a href="https://docs.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üìö</span>Celo Documentation </a>
                <a href="https://developers.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üíº</span>Developer Portal </a>
                <a href="https://celoscan.io" target="_blank" class="celo-link"> <span class="celo-link-icon">üîç</span>Celo Explorer </a>
                <a href="https://forum.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üí¨</span>Celo Forum </a>
                <a href="https://x.com/Celo" target="_blank" class="celo-link"> <span class="celo-link-icon">üê¶</span>Celo Twitter </a>
                <a href="https://chat.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üí¨</span>Celo Discord </a>
                <a href="https://blog.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üì∞</span>Celo Blog </a>
                <a href="https://github.com/celo-org" target="_blank" class="celo-link"> <span class="celo-link-icon">üíª</span>Celo GitHub </a>
            </div>

            <!-- Platform Stats -->
            <div id="platformStats" class="stats-container hidden">
                <div class="stat-card">
                    <div>üë• Total Users</div>
                    <div class="stat-value" id="totalUsers">0</div>
                </div>
                <div class="stat-card">
                    <div>üìã Proposals</div>
                    <div class="stat-value" id="totalProposals">0</div>
                </div>
                <div class="stat-card">
                    <div>üéñÔ∏è Badges</div>
                    <div class="stat-value" id="totalBadges">0</div>
                </div>
                <div class="stat-card">
                    <div>üëç Supports</div>
                    <div class="stat-value" id="totalSupports">0</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="content-layout">
                <!-- ERROR MESSAGE SECTION -->
                <div id="errorSection" class="error-message hidden">
                    <h3>‚ö†Ô∏è Transaction Error</h3>
                    <p id="errorText"></p>
                    <button onclick="document.getElementById('errorSection').classList.add('hidden')">Close</button>
                </div>

                <!-- USER PROFILE SECTION -->
                <div id="userProfileSection" class="hidden">
                    <div class="step-indicator">
                        <span class="step-number">üë§</span> Your Profile
                    </div>
                    <div class="submit-form">
                        <h3>üÜî Setup Your Profile</h3>
                        <input type="text" placeholder="Enter your username..." id="userUsername" />
                        <input type="text" placeholder="Paste your X, Farcaster, GitHub link..." id="userLink" />
                        <div class="gas-info"> ‚õΩ Setup your profile to unlock all features </div>
                        <button id="setupProfileBtn">üöÄ Setup Profile</button>
                    </div>
                </div>

                <!-- SUBMIT YOUR LINK SECTION -->
                <div id="step2" class="submit-section hidden">
                    <div class="step-indicator">
                        <span class="step-number">2</span> Submit Your Link
                    </div>
                    <div class="success-message"> ‚úÖ Thank you for supporting! Now you can submit your own link </div>
                    <div id="networkWarning" class="network-warning hidden"> ‚ö†Ô∏è Please switch to Celo Mainnet to submit your link </div>
                    <div class="submit-form">
                        <h3>üéâ Add Your Content</h3>
                        <input type="text" placeholder="Paste your X, Farcaster, GitHub, or any other link here..." id="userLinkInput" />
                        <br>
                        <div class="gas-info"> ‚õΩ You'll only pay the normal network gas fee (no extra cost) </div>
                        <button id="submitLinkBtn">‚úçÔ∏è Submit Link</button>
                        <p><small>üîí Secure transaction on Celo network</small></p>
                    </div>
                </div>

                <!-- SUPPORT COMMUNITY SECTION -->
                <div id="step1" class="support-section">
                    <div class="step-indicator">
                        <span class="step-number">1</span> Support Community Members
                    </div>
                    <div class="step-container">
                        <h3>üìã Support Others First</h3>
                        <p>To submit your link, you must first support at least one community member</p>
                        <div class="links-grid" id="linksContainer"> </div>
                    </div>
                </div>

                <!-- GOVERNANCE SECTION -->
                <div id="governanceSection" class="governance-section hidden">
                    <div class="step-indicator">
                        <span class="step-number">üèõÔ∏è</span> Community Governance
                    </div>
                    <div class="step-container">
                        <h3>üó≥Ô∏è Create Proposal</h3>
                        <input type="text" placeholder="Proposal title..." id="proposalTitle" />
                        <textarea placeholder="Proposal description..." id="proposalDescription" rows="3"></textarea>
                        <button id="createProposalBtn">üìù Create Proposal</button>

                        <h3 style="margin-top: 30px;">üìã Active Proposals</h3>
                        <div id="proposalsContainer"></div>
                    </div>
                </div>

                <!-- BADGES SECTION -->
                <div id="badgesSection" class="badge-section hidden">
                    <div class="step-indicator">
                        <span class="step-number">üéñÔ∏è</span> Your Badges
                    </div>
                    <div class="step-container">
                        <h3>üèÜ Your Achievements</h3>
                        <div id="userBadgesContainer"></div>
                    </div>
                </div>

                <!-- CREATE2 FACTORY SECTION -->
                <div id="factorySection" class="factory-section hidden">
                    <div class="step-indicator">
                        <span class="step-number">üè≠</span> Create2 Factory
                    </div>
                    <div class="step-container">
                        <h3>üöÄ Smart Contract Deployment</h3>
                        <p>Deploy new contracts using CREATE2 for deterministic addresses</p>
                        
                        <div class="factory-card">
                            <h4>üìù Deploy New Contract</h4>
                            <textarea placeholder="Enter contract bytecode (0x...)" id="contractBytecode" rows="4"></textarea>
                            <input type="number" placeholder="Salt value (number)" id="contractSalt" />
                            <div class="gas-info">‚õΩ Gas estimate: ~200,000 - 500,000</div>
                            <button id="deployContractBtn">üè≠ Deploy Contract</button>
                        </div>

                        <div class="factory-card">
                            <h4>üîç Compute Contract Address</h4>
                            <textarea placeholder="Enter bytecode to compute address" id="computeBytecode" rows="3"></textarea>
                            <input type="number" placeholder="Salt value" id="computeSalt" />
                            <button id="computeAddressBtn">üßÆ Compute Address</button>
                            <div id="computedAddress" class="factory-result hidden"></div>
                        </div>

                        <div class="factory-card">
                            <h4>üí∞ Check Contract Balance</h4>
                            <input type="text" placeholder="Contract address (0x...)" id="balanceContractAddress" />
                            <button id="checkBalanceBtn">üìä Check Balance</button>
                            <div id="contractBalance" class="factory-result hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // State management
        let provider = null;
        let signer = null;
        let isConnected = false;
        let userAddress = '';
        let hasSupported = false;
        let currentChainId = null;
        let userProfile = null;

        // ‚úÖ G√úNCEL CELO CONTRACT ADDRESS
        const CONTRACT_ADDRESS = "0x22eA49c074098931a478F381f971C77486d185b2";

        // ‚úÖ CREATE2 FACTORY CONTRACT ADDRESS
        const FACTORY_ADDRESS = "0xe557Eb1ce745EB272Fd99941C9AD1E2867C7E01A";

        // ‚úÖ G√úNCEL Contract ABI - HATA D√úZELTMELERƒ∞ ƒ∞LE
        const CONTRACT_ABI = [
            "function registerUser(string memory _username, string memory _link) public",
            "function updateProfile(string memory _username, string memory _link) public",
            "function createProposal(string memory _title, string memory _description, uint256 _duration) public",
            "function voteProposal(uint256 _proposalId, bool _support) public",
            "function awardBadge(address _user, string memory _badge) public",
            "function getUserProfile(address _user) public view returns (string memory link, string memory username, uint256 supportCount, uint256 reputation, uint256 badgeCount, bool isActive, uint256 timestamp)",
            "function getUserBadges(address _user) public view returns (string[] memory)",
            "function getActiveProposals() public view returns (uint256[] memory)",
            "function getProposalDetails(uint256 _proposalId) public view returns (uint256 id, string memory title, string memory description, address creator, uint256 votesFor, uint256 votesAgainst, uint256 deadline, bool executed)",
            "function totalUsers() public view returns (uint256)",
            "function proposalCount() public view returns (uint256)",
            "function getAllUsers() public view returns (address[] memory)",
            "event UserRegistered(address indexed user, string username)",
            "event ProposalCreated(uint256 indexed proposalId, string title, address creator)",
            "event Voted(uint256 indexed proposalId, address indexed voter, bool support)",
            "event BadgeAwarded(address indexed user, string badge)"
        ];

        // ‚úÖ CREATE2 FACTORY ABI
        const FACTORY_ABI = [
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "deployedAddress",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "creator",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "salt",
                        "type": "uint256"
                    }
                ],
                "name": "ContractDeployed",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "bytes",
                        "name": "bytecode",
                        "type": "bytes"
                    },
                    {
                        "internalType": "uint256",
                        "name": "salt",
                        "type": "uint256"
                    }
                ],
                "name": "deploy",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "bytes",
                        "name": "bytecode",
                        "type": "bytes"
                    },
                    {
                        "internalType": "uint256",
                        "name": "salt",
                        "type": "uint256"
                    }
                ],
                "name": "computeAddress",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "contractAddress",
                        "type": "address"
                    }
                ],
                "name": "getContractBalance",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // ‚úÖ ALTERNATƒ∞F RPC URL'LER
        const CELO_RPC_URLS = [
            "https://forno.celo.org",
            "https://1rpc.io/celo",
            "https://celo.api.onfinality.io/public",
            "https://celo-mainnet.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161"
        ];

        let currentRpcIndex = 0;

        // Celo Network Configuration
        const CELO_MAINNET_PARAMS = {
            chainId: "0xA4EC",
            chainName: "Celo Mainnet",
            nativeCurrency: { name: "CELO", symbol: "CELO", decimals: 18 },
            rpcUrls: CELO_RPC_URLS,
            blockExplorerUrls: ["https://celoscan.io/"]
        };

        const CELO_ALFAJORES_PARAMS = {
            chainId: "0xAEF3",
            chainName: "Celo Alfajores Testnet",
            nativeCurrency: { name: "CELO", symbol: "CELO", decimals: 18 },
            rpcUrls: ["https://alfajores-forno.celo-testnet.org"],
            blockExplorerUrls: ["https://alfajores.celoscan.io/"]
        };

        // Initial support links
        const initialSupportLinks = [
            "https://farcaster.xyz/teberen/0x391c5713",
            "https://farcaster.xyz/ertu",
            "https://farcaster.xyz/ratmubaba",
            "https://x.com/erturulsezar13?s=21&t=l2lmnRZcmeoUCu9IdzeRpA",
            "https://x.com/egldmvx?s=21&t=l2lmnRZcmeoUCu9IdzeRpA",
            "https://tebberen.github.io/celo-engage-hub/",
            "https://x.com/meelioodas?s=21&t=l2lmnRZcmeoUCu9IdzeRpA",
            "https://x.com/luckyfromnecef/status/1972371920290259437?s=46&t=l2lmnRZcmeoUCu9IdzeRpA",
            "https://github.com/tebberen"
        ];

        // Utility functions
        function getPlatformName(url) {
            if (url.includes('x.com') || url.includes('twitter.com')) return 'üê¶ X';
            if (url.includes('farcaster.xyz') || url.includes('warpcast.com')) return 'üîÆ Farcaster';
            if (url.includes('github.com')) return 'üíª GitHub';
            if (url.includes('youtube.com')) return 'üì∫ YouTube';
            if (url.includes('discord.com')) return 'üí¨ Discord';
            return 'üåê Website';
        }

        function displaySupportLinks() {
            const container = document.getElementById('linksContainer');
            container.innerHTML = '';
            const storedLinks = localStorage.getItem('celoEngageHubLinks');
            const allCommunityLinks = storedLinks ? JSON.parse(storedLinks) : initialSupportLinks.map(link => ({ link: link, clickCount: 0, timestamp: Date.now(), submitter: "community" }));
            
            const activeLinks = allCommunityLinks.filter(linkData => linkData.clickCount < 5);
            if (activeLinks.length === 0) {
                container.innerHTML = `
                <div style="grid-column: 1 / -1;">
                    <div class="link-card">
                        <p>üåü All links have reached maximum support! Submit new links to continue.</p>
                    </div>
                </div>
                `;
                return;
            }
            activeLinks.sort((a, b) => a.clickCount - b.clickCount);
            activeLinks.forEach((linkData, index) => {
                const platform = getPlatformName(linkData.link);
                const linkCard = document.createElement('div');
                linkCard.innerHTML = `
                <div class="link-card">
                    <div>
                        <div class="link-platform">${platform}</div>
                        <a href="${linkData.link}" target="_blank" class="support-link" onclick="handleLinkClick('${linkData.link}')">
                        ${linkData.link}
                        </a>
                    </div>
                    <div class="link-stats">
                        <div class="stat-item">
                            <div>Supports</div>
                            <div class="stat-value">${linkData.clickCount}/5</div>
                        </div>
                    </div>
                    <button class="supportBtn" onclick="markAsSupported('${linkData.link}')">üëç Support This Content</button>
                </div>
                `;
                container.appendChild(linkCard);
            });
        }

        // ‚úÖ GELƒ∞≈ûMƒ∞≈û HATA Y√ñNETƒ∞Mƒ∞
        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorSection.classList.remove('hidden');
        }

        // ‚úÖ ALTERNATƒ∞F RPC SAƒûLAYICI
        function getNextRpcUrl() {
            currentRpcIndex = (currentRpcIndex + 1) % CELO_RPC_URLS.length;
            return CELO_RPC_URLS[currentRpcIndex];
        }

        // ‚úÖ OPTƒ∞Mƒ∞ZE EDƒ∞LMƒ∞≈û PROVIDER
        async function getProvider() {
            if (window.ethereum) {
                return new ethers.providers.Web3Provider(window.ethereum);
            } else {
                // Fallback provider
                const rpcUrl = getNextRpcUrl();
                return new ethers.providers.JsonRpcProvider(rpcUrl);
            }
        }

        // Platform Stats
        async function loadPlatformStats() {
            if (!provider || !isConnected) return;

            try {
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const totalUsers = await contract.totalUsers();
                const proposalCount = await contract.proposalCount();

                document.getElementById('totalUsers').textContent = totalUsers.toString();
                document.getElementById('totalProposals').textContent = proposalCount.toString();
                document.getElementById('platformStats').classList.remove('hidden');
            } catch (error) {
                console.log("Stats loading skipped:", error.message);
            }
        }

        // User Profile Y√ºkleme
        async function loadUserProfile() {
            if (!provider || !isConnected) return;

            try {
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const profile = await contract.getUserProfile(userAddress);

                userProfile = {
                    link: profile[0],
                    username: profile[1],
                    supportCount: profile[2],
                    reputation: profile[3],
                    badgeCount: profile[4],
                    isActive: profile[5],
                    timestamp: profile[6]
                };

                if (userProfile.isActive) {
                    document.getElementById('userProfileSection').classList.add('hidden');
                    document.getElementById('governanceSection').classList.remove('hidden');
                    document.getElementById('badgesSection').classList.remove('hidden');
                    document.getElementById('factorySection').classList.remove('hidden');
                    loadUserBadges();
                    loadProposals();
                } else {
                    document.getElementById('userProfileSection').classList.remove('hidden');
                }
            } catch (error) {
                console.log("User profile not found, showing setup form");
                document.getElementById('userProfileSection').classList.remove('hidden');
            }
        }

        // ‚úÖ G√úNCEL PROFILE SETUP - STATE SORUNU √á√ñZ√úML√ú
        async function setupUserProfile() {
            if (!isConnected) {
                const connected = await connectWallet();
                if (!connected) return;
            }

            const username = document.getElementById("userUsername").value.trim();
            const link = document.getElementById("userLink").value.trim();

            if (!username || !link) {
                alert("‚ùå Please enter both username and link");
                return;
            }

            try {
                document.getElementById("setupProfileBtn").disabled = true;
                document.getElementById("setupProfileBtn").textContent = "‚è≥ Setting up...";

                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                // ‚úÖ GAS LIMIT ARTIRIMI VE STATE SORUNU √á√ñZ√úM√ú
                const tx = await contract.registerUser(username, link, {
                    gasLimit: 800000,
                    gasPrice: ethers.utils.parseUnits('1', 'gwei')
                });

                console.log("üîÑ Profile setup TX:", tx.hash);
                alert(`‚è≥ Profile setup submitted!\nTX Hash: ${tx.hash}`);

                const receipt = await tx.wait();
                console.log("‚úÖ Transaction confirmed:", receipt);

                alert("‚úÖ Profile setup successfully!");
                loadUserProfile();

            } catch (error) {
                console.error("‚ùå Profile setup error:", error);
                
                if (error.code === 4001) {
                    showError("‚ùå Transaction rejected by user");
                } else if (error.message.includes("execution reverted")) {
                    showError("‚ùå Contract execution reverted. You may already be registered.");
                } else if (error.code === 'INSUFFICIENT_FUNDS') {
                    showError("‚ùå Insufficient funds for gas fee. Please add CELO to your wallet.");
                } else {
                    showError("‚ùå Setup failed: " + error.message);
                }
            } finally {
                document.getElementById("setupProfileBtn").disabled = false;
                document.getElementById("setupProfileBtn").textContent = "üöÄ Setup Profile";
            }
        }

        // ‚úÖ G√úNCEL SUBMIT LINK - STATE SORUNU √á√ñZ√úML√ú
        async function submitLink() {
            if (!isConnected) {
                const connected = await connectWallet();
                if (!connected) return;
            }
            if (!hasSupported) {
                alert("‚ùå Please support at least one community member first!");
                return;
            }

            const userLink = document.getElementById("userLinkInput").value.trim();
            if (!userLink) {
                alert("‚ùå Please enter your link first.");
                return;
            }
            if (!userLink.startsWith('http://') && !userLink.startsWith('https://')) {
                alert("‚ùå Please enter a valid URL starting with http:// or https://");
                return;
            }

            try {
                document.getElementById("submitLinkBtn").disabled = true;
                document.getElementById("submitLinkBtn").textContent = "‚è≥ Submitting...";

                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                // ‚úÖ OPTƒ∞Mƒ∞ZE EDƒ∞LMƒ∞≈û TRANSACTION
                const tx = await contract.registerUser("CommunityUser", userLink, {
                    gasLimit: 800000,
                    gasPrice: ethers.utils.parseUnits('1', 'gwei')
                });

                console.log("üîÑ Submit link TX:", tx.hash);
                alert(`‚è≥ Link submission submitted!\nTX Hash: ${tx.hash}`);

                const receipt = await tx.wait();
                console.log("‚úÖ Transaction confirmed:", receipt);

                alert("‚úÖ Link submitted successfully!");

                // ‚úÖ LOCAL STORAGE G√úNCELLEME
                const storedLinks = localStorage.getItem('celoEngageHubLinks');
                const allCommunityLinks = storedLinks ? JSON.parse(storedLinks) : initialSupportLinks.map(link => ({ link: link, clickCount: 0, timestamp: Date.now(), submitter: "community" }));
                
                const newLinkData = {
                    link: userLink,
                    clickCount: 0,
                    timestamp: Date.now(),
                    submitter: userAddress
                };
                allCommunityLinks.unshift(newLinkData);
                localStorage.setItem('celoEngageHubLinks', JSON.stringify(allCommunityLinks));
                
                displaySupportLinks();
                document.getElementById("userLinkInput").value = "";
                hasSupported = false;
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step1').classList.remove('hidden');

            } catch (error) {
                console.error("‚ùå Submit error:", error);
                
                if (error.code === 4001) {
                    showError("‚ùå Transaction rejected by user");
                } else if (error.code === 'INSUFFICIENT_FUNDS') {
                    showError("‚ùå Insufficient funds for gas fee. Please add CELO to your wallet.");
                } else if (error.message.includes("execution reverted")) {
                    showError("‚ùå You may already be registered. Try updating your profile instead.");
                } else {
                    showError("‚ùå Submission failed: " + error.message);
                }
            } finally {
                document.getElementById("submitLinkBtn").disabled = false;
                document.getElementById("submitLinkBtn").textContent = "‚úçÔ∏è Submit Link";
            }
        }

        // Diƒüer fonksiyonlar aynƒ± kalacak, sadece error handling eklendi
        async function createProposal() {
            const title = document.getElementById("proposalTitle").value.trim();
            const description = document.getElementById("proposalDescription").value.trim();

            if (!title || !description) {
                alert("‚ùå Please enter both title and description");
                return;
            }

            try {
                document.getElementById("createProposalBtn").disabled = true;
                document.getElementById("createProposalBtn").textContent = "‚è≥ Creating...";

                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                const duration = 3 * 24 * 60 * 60;

                const tx = await contract.createProposal(title, description, duration, {
                    gasLimit: 800000
                });

                console.log("üîÑ Proposal TX sent:", tx.hash);
                alert(`‚è≥ Proposal submitted!\nTX Hash: ${tx.hash}`);

                await tx.wait();
                alert("‚úÖ Proposal created successfully!");
                loadProposals();

            } catch (error) {
                console.error("‚ùå Proposal creation error:", error);
                showError("‚ùå Proposal creation failed: " + error.message);
            } finally {
                document.getElementById("createProposalBtn").disabled = false;
                document.getElementById("createProposalBtn").textContent = "üìù Create Proposal";
            }
        }

        // Kalan fonksiyonlar orijinal hallerinde kalacak...
        // [Proposals, Voting, Badges, Factory functions - previous version ile aynƒ±]

        // Network functions
        async function switchToCeloNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: CELO_MAINNET_PARAMS.chainId }],
                });
                return true;
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [CELO_MAINNET_PARAMS],
                        });
                        return true;
                    } catch (addError) {
                        console.error("Error adding Celo network:", addError);
                        return false;
                    }
                }
                return false;
            }
        }

        async function checkCurrentNetwork() {
            if (!provider) return false;
            try {
                const network = await provider.getNetwork();
                currentChainId = network.chainId.toString();
                const networkInfo = document.getElementById('networkInfo');
                if (currentChainId === "42220" || currentChainId === "44787") {
                    networkInfo.innerHTML = `üåê Celo ${currentChainId === "42220" ? "Mainnet" : "Alfajores"}`;
                    networkInfo.style.color = "#35D07F";
                    return true;
                } else {
                    networkInfo.innerHTML = `‚ö†Ô∏è Wrong Network - Please switch to Celo`;
                    networkInfo.style.color = "#EF4444";
                    return false;
                }
            } catch (error) {
                console.error("Error checking network:", error);
                return false;
            }
        }

        function handleLinkClick(linkUrl) {
            const storedLinks = localStorage.getItem('celoEngageHubLinks');
            const allCommunityLinks = storedLinks ? JSON.parse(storedLinks) : initialSupportLinks.map(link => ({ link: link, clickCount: 0, timestamp: Date.now(), submitter: "community" }));
            
            const linkData = allCommunityLinks.find(item => item.link === linkUrl);
            if (linkData && linkData.clickCount < 5) {
                linkData.clickCount++;
                localStorage.setItem('celoEngageHubLinks', JSON.stringify(allCommunityLinks));
                displaySupportLinks();
            }
        }

        function markAsSupported(linkUrl) {
            handleLinkClick(linkUrl);
            hasSupported = true;
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        }

        function checkMetaMask() {
            if (typeof window.ethereum === 'undefined') {
                alert("‚ùå MetaMask not detected. Please install MetaMask first.");
                return false;
            }
            return true;
        }

        async function connectWallet() {
            if (!checkMetaMask()) return false;
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await switchToCeloNetwork();
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                document.getElementById('walletAddress').textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
                document.getElementById('walletInfo').classList.remove('hidden');
                document.getElementById('connectWalletBtn').style.display = 'none';
                isConnected = true;
                await checkCurrentNetwork();

                loadPlatformStats();
                loadUserProfile();

                return true;
            } catch (error) {
                console.error("Connection error:", error);
                if (error.code === 4001) {
                    alert("‚ùå Connection rejected. Please connect to continue.");
                } else {
                    alert("‚ùå Connection failed: " + error.message);
                }
                return false;
            }
        }

        // Event listeners
        document.getElementById("connectWalletBtn").addEventListener("click", connectWallet);
        document.getElementById("submitLinkBtn").addEventListener("click", submitLink);
        document.getElementById("setupProfileBtn").addEventListener("click", setupUserProfile);
        document.getElementById("createProposalBtn").addEventListener("click", createProposal);

        // Initialize
        window.addEventListener('load', function() {
            displaySupportLinks();
            if (checkMetaMask()) {
                setTimeout(async () => {
                    try {
                        provider = new ethers.providers.Web3Provider(window.ethereum);
                        const accounts = await provider.listAccounts();
                        if (accounts.length > 0) {
                            await connectWallet();
                        }
                    } catch (error) {
                        console.log("No previous connection found");
                    }
                }, 1000);
            }
        });

        // Global functions
        window.markAsSupported = markAsSupported;
        window.connectWallet = connectWallet;
        window.handleLinkClick = handleLinkClick;
    </script>
</body>
</html>
